<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <title>Graphs</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
  <nav>
	<h4>LORAWAN</h4>
	<ul>
		<li><a href="/logged">Home</a></li>
		<li><a href="/sensors">My Sensors</a></li>
		<li><a href="/locals">Locals</a></li>
		<li><a href="/logout">Logout</a></li>
	</ul>
</nav>

  <h1>Temperature and Humidity Graph of {{this.sensorname}}</h1>

  <div>
    <canvas id="sensorChart"></canvas>
  </div>

  <div>
    <label for="dateFilter">Select Date:</label>
    <input type="text" id="dateFilter" placeholder="Select a date">
  </div>

  <div>
    <label for="startHour">Start Hour:</label>
    <input type="text" id="startHour" placeholder="HH:mm">
  </div>
  <div>
    <label for="endHour">End Hour:</label>
    <input type="text" id="endHour" placeholder="HH:mm">
  </div>
  <button onclick="filterData()">Filter</button>

  

  <script>
    let allTemperatures = {{{temperatures}}};
    let allHumidities = {{{humidities}}};

    // Obtenha o contexto do canvas
    const ctx = document.getElementById('sensorChart').getContext('2d');

    // Crie o gráfico
    let sensorChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: allTemperatures.map(reading => {
          const createdAt = new Date(reading.createdAt);
          const formattedDate = formatDate(createdAt);
          return formattedDate;
        }),
        datasets: [
          {
            label: 'Temperature (ºC)',
            data: allTemperatures.map(reading => reading.temperature),
            borderColor: 'red',
            fill: false
          },
          {
            label: 'Humidity (%)',
            data: allHumidities.map(reading => reading.humidity),
            borderColor: 'blue',
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: 'Data'
            }
          },
          y: {
            display: true,
            title: {
              display: true,
              text: 'Valor Temperatura e Humidade'
            }
          }
        }
      }
    });

    const datePicker = flatpickr("#dateFilter", {
      dateFormat: "d/m/Y",
      onClose: function(selectedDates) {
        if (selectedDates.length > 0) {
          const selectedDate = selectedDates[0];
          const formattedDate = formatDate(selectedDate);
          document.getElementById('dateFilter').value = formattedDate;
        }
      }
    });

    const startTimePicker = flatpickr("#startHour", {
      enableTime: true,
      noCalendar: true,
      dateFormat: "H:i",
    });

    const endTimePicker = flatpickr("#endHour", {
      enableTime: true,
      noCalendar: true,
      dateFormat: "H:i",
    });

    function filterData() {
      const selectedDate = getDateFromInput(document.getElementById('dateFilter').value);

      const startHourInput = startTimePicker.input.value;
      const endHourInput = endTimePicker.input.value;

      const [startHour, startMinute] = startHourInput.split(':').map(Number);
      const [endHour, endMinute] = endHourInput.split(':').map(Number);

      // Filtrar as leituras com base na data selecionada e intervalo de horas
      const filteredTemperatures = allTemperatures.filter(reading => {
        const createdAt = new Date(reading.createdAt);
        const hour = createdAt.getHours();
        const minute = createdAt.getMinutes();
        return (
          createdAt.getDate() === selectedDate.getDate() &&
          createdAt.getMonth() === selectedDate.getMonth() &&
          createdAt.getFullYear() === selectedDate.getFullYear() &&
          (hour > startHour || (hour === startHour && minute >= startMinute)) &&
          (hour < endHour || (hour === endHour && minute <= endMinute))
        );
      });

      const filteredHumidities = allHumidities.filter(reading => {
        const createdAt = new Date(reading.createdAt);
        const hour = createdAt.getHours();
        const minute = createdAt.getMinutes();
        return (
          createdAt.getDate() === selectedDate.getDate() &&
          createdAt.getMonth() === selectedDate.getMonth() &&
          createdAt.getFullYear() === selectedDate.getFullYear() &&
          (hour > startHour || (hour === startHour && minute >= startMinute)) &&
          (hour < endHour || (hour === endHour && minute <= endMinute))
        );
      });

      // Atualizar o gráfico com as leituras filtradas
      updateChart(filteredTemperatures, filteredHumidities);
    }

    function updateChart(temperatures, humidities) {
      sensorChart.data.labels = temperatures.map(reading => {
        const createdAt = new Date(reading.createdAt);
        const formattedDate = formatDate(createdAt);
        return formattedDate;
      });
      sensorChart.data.datasets[0].data = temperatures.map(reading => reading.temperature);
      sensorChart.data.datasets[1].data = humidities.map(reading => reading.humidity);
      sensorChart.update();
    }

    function formatDate(date) {
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const hour = date.getHours().toString().padStart(2, '0');
      const minute = date.getMinutes().toString().padStart(2, '0');
      return `${day}/${month} - ${hour}:${minute}`;
    }

    function getDateFromInput(inputValue) {
      const [day, month, year] = inputValue.split('/').map(Number);
      return new Date(year, month - 1, day);
    }
  </script>
</body>
</html>
